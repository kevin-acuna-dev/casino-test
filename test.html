<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blackjack 21</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Orbitron:wght@400;700;900&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Roboto Condensed", sans-serif;
        background: linear-gradient(
          135deg,
          #0a0a0a 0%,
          #1a1a1a 50%,
          #0f0f0f 100%
        );
        background-attachment: fixed;
        color: #e0e0e0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        position: relative;
        overflow-x: hidden;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(0, 100, 200, 0.03) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(0, 150, 255, 0.02) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: 0;
      }

      .container {
        background: linear-gradient(145deg, #1e1e1e 0%, #252525 100%);
        border: 3px solid #333;
        border-radius: 16px;
        padding: 40px;
        max-width: 1100px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        position: relative;
        z-index: 1;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        border-bottom: 3px solid #333;
        padding-bottom: 25px;
        position: relative;
      }

      .header::after {
        content: "";
        position: absolute;
        bottom: -3px;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        height: 3px;
        background: linear-gradient(90deg, transparent, #0066cc, transparent);
      }

      .header h1 {
        font-family: "Orbitron", sans-serif;
        color: #ffffff;
        font-size: 3.5em;
        font-weight: 900;
        letter-spacing: 8px;
        text-transform: uppercase;
        text-shadow: 0 0 20px rgba(0, 102, 204, 0.5),
          0 4px 10px rgba(0, 0, 0, 0.8);
        margin-bottom: 10px;
      }

      .header .subtitle {
        color: #888;
        font-size: 0.9em;
        letter-spacing: 3px;
        text-transform: uppercase;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 35px;
      }

      .stat-box {
        background: linear-gradient(145deg, #1a1a1a, #222);
        border: 2px solid #333;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.3s;
      }

      .stat-box::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, #0066cc, #0088ff);
        transform: scaleX(0);
        transition: transform 0.3s;
      }

      .stat-box:hover {
        border-color: #0066cc;
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 102, 204, 0.2);
      }

      .stat-box:hover::before {
        transform: scaleX(1);
      }

      .stat-label {
        color: #999;
        font-size: 0.85em;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 400;
      }

      .stat-value {
        color: #ffffff;
        font-size: 2em;
        font-weight: 700;
        font-family: "Orbitron", sans-serif;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      }

      .stat-box:nth-child(1) .stat-value {
        color: #00ff88;
      }

      .stat-box:nth-child(2) .stat-value {
        color: #ffaa00;
      }

      .betting-section {
        background: linear-gradient(145deg, #1a1a1a, #222);
        border: 2px solid #333;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 35px;
      }

      .betting-title {
        text-align: center;
        margin-bottom: 20px;
        color: #ffffff;
        font-weight: 700;
        font-size: 1.3em;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .betting-controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
      }

      .bet-btn {
        background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
        border: 2px solid #444;
        color: #ffffff;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 700;
        transition: all 0.3s;
        min-width: 70px;
        position: relative;
        overflow: hidden;
      }

      .bet-btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(0, 102, 204, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.3s, height 0.3s;
      }

      .bet-btn:hover::before {
        width: 300px;
        height: 300px;
      }

      .bet-btn:hover {
        border-color: #0066cc;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 102, 204, 0.4);
      }

      .bet-btn:active {
        transform: translateY(0);
      }

      .bet-btn.selected {
        background: linear-gradient(145deg, #0066cc, #004499);
        border-color: #0088ff;
        box-shadow: 0 0 20px rgba(0, 102, 204, 0.6);
      }

      .bet-input {
        background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
        border: 2px solid #444;
        color: #ffffff;
        padding: 12px;
        border-radius: 8px;
        width: 140px;
        text-align: center;
        font-size: 1.1em;
        font-weight: 700;
        transition: all 0.3s;
      }

      .bet-input:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 15px rgba(0, 102, 204, 0.3);
      }

      .game-area {
        margin-bottom: 35px;
        background: linear-gradient(145deg, #151515, #1a1a1a);
        border: 2px solid #333;
        border-radius: 12px;
        padding: 30px;
      }

      .dealer-section,
      .player-section {
        margin-bottom: 30px;
      }

      .dealer-section {
        padding-bottom: 30px;
        border-bottom: 2px solid #333;
      }

      .section-title {
        color: #ffffff;
        font-size: 1.4em;
        margin-bottom: 20px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-title::before {
        content: "";
        width: 4px;
        height: 20px;
        background: linear-gradient(180deg, #0066cc, #0088ff);
        border-radius: 2px;
      }

      .cards-container {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        min-height: 160px;
        margin-bottom: 20px;
        align-items: center;
      }

      .card {
        width: 100px;
        height: 140px;
        background: #ffffff;
        border: 3px solid #1a1a1a;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.9);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        animation: cardDeal 0.5s ease-out;
      }

      @keyframes cardDeal {
        from {
          opacity: 0;
          transform: translateY(-50px) rotate(-10deg);
        }
        to {
          opacity: 1;
          transform: translateY(0) rotate(0deg);
        }
      }

      .card:hover {
        transform: translateY(-8px) rotate(2deg);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.9);
      }

      .card.hidden {
        background: linear-gradient(
          135deg,
          #1a3a5a 0%,
          #2a4a6a 50%,
          #1a3a5a 100%
        );
        border-color: #3a5a7a;
        position: relative;
      }

      .card.hidden::before {
        content: "‚ô†";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3em;
        color: rgba(255, 255, 255, 0.1);
      }

      .card.hidden .card-value,
      .card.hidden .card-suit {
        visibility: hidden;
      }

      .card-value {
        color: #1a1a1a;
        font-size: 1.4em;
        font-weight: 900;
        font-family: "Roboto Condensed", sans-serif;
        line-height: 1;
      }

      .card-suit {
        color: #1a1a1a;
        font-size: 2.2em;
        text-align: center;
        line-height: 1;
      }

      .card.red .card-value,
      .card.red .card-suit {
        color: #cc0000;
      }

      .score {
        color: #ffffff;
        font-size: 1.3em;
        font-weight: 700;
        margin-top: 15px;
        font-family: "Orbitron", sans-serif;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      }

      .controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 35px;
      }

      .btn {
        background: linear-gradient(145deg, #0066cc, #004499);
        border: 2px solid #0088ff;
        color: #ffffff;
        padding: 15px 35px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 700;
        transition: all 0.3s;
        min-width: 140px;
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3);
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        transform: translate(-50%, -50%);
        transition: width 0.4s, height 0.4s;
      }

      .btn:hover::before {
        width: 400px;
        height: 400px;
      }

      .btn:hover {
        background: linear-gradient(145deg, #0088ff, #0066cc);
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 136, 255, 0.5);
      }

      .btn:active {
        transform: translateY(-1px);
      }

      .btn:disabled {
        background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
        border-color: #444;
        color: #666;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn:disabled::before {
        display: none;
      }

      .btn.danger {
        background: linear-gradient(145deg, #cc3300, #991100);
        border-color: #ff4400;
      }

      .btn.danger:hover {
        background: linear-gradient(145deg, #ff4400, #cc3300);
        box-shadow: 0 6px 20px rgba(255, 68, 0, 0.5);
      }

      .btn.success {
        background: linear-gradient(145deg, #00aa44, #006622);
        border-color: #00cc55;
      }

      .btn.success:hover {
        background: linear-gradient(145deg, #00cc55, #00aa44);
        box-shadow: 0 6px 20px rgba(0, 204, 85, 0.5);
      }

      .message {
        text-align: center;
        padding: 20px;
        margin-top: 25px;
        border-radius: 12px;
        font-size: 1.2em;
        font-weight: 700;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-transform: uppercase;
        letter-spacing: 1px;
        animation: messageSlide 0.4s ease-out;
      }

      @keyframes messageSlide {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.info {
        background: linear-gradient(145deg, #1a3a5a, #0f2a3a);
        color: #88ccff;
        border: 2px solid #2a4a6a;
      }

      .message.win {
        background: linear-gradient(145deg, #1a4a2a, #0f2a1a);
        color: #88ffaa;
        border: 2px solid #2a5a3a;
        box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
      }

      .message.lose {
        background: linear-gradient(145deg, #4a1a1a, #2a0f0f);
        color: #ff8888;
        border: 2px solid #5a2a2a;
        box-shadow: 0 0 30px rgba(255, 136, 136, 0.3);
      }

      .message.draw {
        background: linear-gradient(145deg, #3a3a1a, #2a2a0f);
        color: #ffff88;
        border: 2px solid #4a4a2a;
      }

      @media (max-width: 768px) {
        .container {
          padding: 25px;
        }

        .header h1 {
          font-size: 2.5em;
          letter-spacing: 4px;
        }

        .card {
          width: 75px;
          height: 105px;
          padding: 8px;
        }

        .card-value {
          font-size: 1.1em;
        }

        .card-suit {
          font-size: 1.6em;
        }

        .btn {
          padding: 12px 25px;
          min-width: 120px;
          font-size: 1em;
        }

        .stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      /* Provably Fair Styles */
      .provably-fair-section {
        background: linear-gradient(145deg, #1a1a1a, #222);
        border: 2px solid #333;
        border-radius: 12px;
        margin-top: 30px;
        overflow: hidden;
      }

      .provably-fair-header {
        background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
        padding: 15px 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 700;
        font-size: 1.1em;
        transition: all 0.3s;
        border-bottom: 2px solid #333;
      }

      .provably-fair-header:hover {
        background: linear-gradient(145deg, #333, #2a2a2a);
      }

      #fairToggle {
        transition: transform 0.3s;
      }

      .provably-fair-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
        padding: 0 20px;
      }

      .provably-fair-content.active {
        max-height: 1000px;
        padding: 20px;
      }

      .fair-info {
        background: linear-gradient(145deg, #151515, #1a1a1a);
        border: 2px solid #2a2a2a;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .fair-info p {
        margin: 5px 0;
        line-height: 1.6;
      }

      .fair-info strong {
        color: #0066cc;
      }

      .seed-display {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
      }

      .seed-item {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .seed-item label {
        min-width: 200px;
        font-weight: 600;
        color: #999;
      }

      .seed-item input {
        flex: 1;
        background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
        border: 2px solid #444;
        color: #ffffff;
        padding: 10px;
        border-radius: 6px;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
        min-width: 200px;
      }

      .seed-item input:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 10px rgba(0, 102, 204, 0.3);
      }

      .copy-btn,
      .btn-small {
        background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
        border: 2px solid #444;
        color: #ffffff;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s;
      }

      .copy-btn:hover,
      .btn-small:hover {
        border-color: #0066cc;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 102, 204, 0.3);
      }

      .fair-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 20px;
      }

      .fair-actions .btn {
        min-width: auto;
        padding: 12px 20px;
        font-size: 0.95em;
      }

      .verification-result {
        background: linear-gradient(145deg, #151515, #1a1a1a);
        border: 2px solid #2a2a2a;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        display: none;
      }

      .verification-result.show {
        display: block;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .verification-result.success {
        border-color: #00aa44;
        background: linear-gradient(145deg, #1a2a1a, #0f1a0f);
      }

      .verification-result.error {
        border-color: #cc3300;
        background: linear-gradient(145deg, #2a1a1a, #1a0f0f);
      }

      .game-history {
        margin-top: 15px;
        max-height: 300px;
        overflow-y: auto;
      }

      .history-item {
        background: linear-gradient(145deg, #1a1a1a, #151515);
        border: 1px solid #333;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        font-size: 0.9em;
      }

      .history-item:hover {
        border-color: #0066cc;
      }

      .history-item .round-number {
        color: #0066cc;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .history-item .result {
        color: #999;
        font-family: "Courier New", monospace;
        font-size: 0.85em;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>BLACKJACK 21</h1>
      </div>

      <div class="stats">
        <div class="stat-box">
          <div class="stat-label">Fichas</div>
          <div class="stat-value" id="chips">1000</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Apuesta Actual</div>
          <div class="stat-value" id="currentBet">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Rondas Ganadas</div>
          <div class="stat-value" id="wins">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Rondas Perdidas</div>
          <div class="stat-value" id="losses">0</div>
        </div>
      </div>

      <div class="betting-section">
        <div class="betting-title">Apostar</div>
        <div class="betting-controls">
          <button class="bet-btn" onclick="setBet(10)">10</button>
          <button class="bet-btn" onclick="setBet(25)">25</button>
          <button class="bet-btn" onclick="setBet(50)">50</button>
          <button class="bet-btn" onclick="setBet(100)">100</button>
          <button class="bet-btn" onclick="setBet(250)">250</button>
          <button class="bet-btn" onclick="setBet(500)">500</button>
          <input
            type="number"
            class="bet-input"
            id="customBet"
            placeholder="Personalizado"
            min="1"
          />
          <button class="bet-btn" onclick="setCustomBet()">Apostar</button>
        </div>
      </div>

      <div class="game-area">
        <div class="dealer-section">
          <div class="section-title">Crupier</div>
          <div class="cards-container" id="dealerCards"></div>
          <div class="score" id="dealerScore">Puntos: 0</div>
        </div>

        <div class="player-section">
          <div class="section-title">Jugador</div>
          <div class="cards-container" id="playerCards"></div>
          <div class="score" id="playerScore">Puntos: 0</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="dealBtn" onclick="dealCards()">Repartir</button>
        <button class="btn" id="hitBtn" onclick="hit()" disabled>
          Pedir Carta
        </button>
        <button class="btn" id="standBtn" onclick="stand()" disabled>
          Plantarse
        </button>
        <button
          class="btn success"
          id="doubleBtn"
          onclick="doubleDown()"
          disabled
        >
          Doblar
        </button>
        <button class="btn danger" id="newGameBtn" onclick="newGame()" disabled>
          Nueva Ronda
        </button>
      </div>

      <div class="message info" id="message">
        Apost√° y presion√° "Repartir" para comenzar
      </div>

      <!-- Provably Fair Section -->
      <div class="provably-fair-section">
        <div class="provably-fair-header" onclick="toggleProvablyFair()">
          <span>üîê Provably Fair - Sistema Verificable</span>
          <span id="fairToggle">‚ñº</span>
        </div>
        <div class="provably-fair-content" id="fairContent">
          <div class="fair-info">
            <p><strong>¬øQu√© es Provably Fair?</strong></p>
            <p>
              Sistema que te permite verificar que cada ronda es justa y no
              manipulada.
            </p>
          </div>

          <div class="seed-display">
            <div class="seed-item">
              <label>üîë Server Seed (Hash):</label>
              <input type="text" id="serverSeedHash" readonly />
              <button class="copy-btn" onclick="copySeed('serverSeedHash')">
                üìã
              </button>
            </div>
            <div class="seed-item">
              <label>üë§ Client Seed:</label>
              <input
                type="text"
                id="clientSeed"
                placeholder="Tu semilla personalizada"
              />
              <button class="btn-small" onclick="generateClientSeed()">
                üé≤ Generar
              </button>
            </div>
            <div class="seed-item">
              <label>üéØ Nonce (Contador de rondas):</label>
              <input type="text" id="nonce" readonly />
            </div>
          </div>

          <div class="fair-actions">
            <button class="btn" onclick="revealServerSeed()">
              üîì Revelar Server Seed
            </button>
            <button class="btn" onclick="showHistory()">
              üìú Ver Historial
            </button>
            <button class="btn success" onclick="verifyFairness()">
              ‚úì Verificar Equidad
            </button>
          </div>

          <div id="verificationResult" class="verification-result"></div>
          <div id="gameHistory" class="game-history"></div>
        </div>
      </div>
    </div>

    <script>
      const suits = ["‚ô†", "‚ô•", "‚ô¶", "‚ô£"];
      const values = [
        "A",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "J",
        "Q",
        "K",
      ];

      let deck = [];
      let playerHand = [];
      let dealerHand = [];
      let currentBet = 0;
      let chips = 1000;
      let wins = 0;
      let losses = 0;
      let gameInProgress = false;
      let canDouble = false;

      function createDeck() {
        deck = [];
        for (let suit of suits) {
          for (let value of values) {
            deck.push({ suit, value });
          }
        }
        shuffleDeck();
      }

      function shuffleDeck() {
        for (let i = deck.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [deck[i], deck[j]] = [deck[j], deck[i]];
        }
      }

      function getCardValue(card) {
        if (card.value === "A") return 11;
        if (["J", "Q", "K"].includes(card.value)) return 10;
        return parseInt(card.value);
      }

      function calculateHand(hand) {
        let total = 0;
        let aces = 0;

        for (let card of hand) {
          if (card.value === "A") {
            aces++;
            total += 11;
          } else {
            total += getCardValue(card);
          }
        }

        while (total > 21 && aces > 0) {
          total -= 10;
          aces--;
        }

        return total;
      }

      function dealCard(hand) {
        if (deck.length === 0) {
          createDeck();
        }
        return hand.push(deck.pop());
      }

      function renderCard(card, container, hidden = false, index = 0) {
        const cardDiv = document.createElement("div");
        cardDiv.className = "card" + (hidden ? " hidden" : "");
        cardDiv.style.animationDelay = `${index * 0.1}s`;

        if (!hidden) {
          const isRed = card.suit === "‚ô•" || card.suit === "‚ô¶";
          if (isRed) {
            cardDiv.classList.add("red");
          }

          const valueDiv = document.createElement("div");
          valueDiv.className = "card-value";
          valueDiv.textContent = card.value;
          cardDiv.appendChild(valueDiv);

          const suitDiv = document.createElement("div");
          suitDiv.className = "card-suit";
          suitDiv.textContent = card.suit;
          cardDiv.appendChild(suitDiv);
        }

        container.appendChild(cardDiv);
      }

      function renderHands() {
        const dealerContainer = document.getElementById("dealerCards");
        const playerContainer = document.getElementById("playerCards");

        dealerContainer.innerHTML = "";
        playerContainer.innerHTML = "";

        dealerHand.forEach((card, index) => {
          renderCard(
            card,
            dealerContainer,
            index === 0 && gameInProgress,
            index
          );
        });

        playerHand.forEach((card, index) => {
          renderCard(card, playerContainer, false, index);
        });

        const dealerScore = document.getElementById("dealerScore");
        const playerScore = document.getElementById("playerScore");

        if (gameInProgress && dealerHand.length > 0) {
          const visibleCard = getCardValue(dealerHand[0]);
          dealerScore.textContent = `Puntos: ${visibleCard}+`;
        } else {
          dealerScore.textContent = `Puntos: ${calculateHand(dealerHand)}`;
        }

        playerScore.textContent = `Puntos: ${calculateHand(playerHand)}`;
      }

      function setBet(amount) {
        if (gameInProgress) return;

        if (chips >= amount) {
          currentBet = amount;
          updateUI();
          document.querySelectorAll(".bet-btn").forEach((btn) => {
            btn.classList.remove("selected");
            if (parseInt(btn.textContent) === amount) {
              btn.classList.add("selected");
            }
          });
        } else {
          showMessage("No ten√©s suficientes fichas", "info");
        }
      }

      function setCustomBet() {
        if (gameInProgress) return;

        const input = document.getElementById("customBet");
        const amount = parseInt(input.value);

        if (amount && amount > 0 && chips >= amount) {
          currentBet = amount;
          input.value = "";
          updateUI();
          document
            .querySelectorAll(".bet-btn")
            .forEach((btn) => btn.classList.remove("selected"));
        } else {
          showMessage("Apuesta inv√°lida o insuficientes fichas", "info");
        }
      }

      function dealCards() {
        if (currentBet === 0) {
          showMessage("Deb√©s hacer una apuesta primero", "info");
          return;
        }

        if (gameInProgress) return;

        chips -= currentBet;
        gameInProgress = true;
        canDouble = true;

        playerHand = [];
        dealerHand = [];

        if (deck.length < 10) {
          createDeck();
        }

        dealCard(playerHand);
        dealCard(dealerHand);
        dealCard(playerHand);
        dealCard(dealerHand);

        renderHands();
        updateUI();

        const playerTotal = calculateHand(playerHand);
        const dealerTotal = calculateHand(dealerHand);

        if (playerTotal === 21) {
          if (dealerTotal === 21) {
            endGame("draw");
          } else {
            endGame("blackjack");
          }
        } else {
          document.getElementById("dealBtn").disabled = true;
          document.getElementById("hitBtn").disabled = false;
          document.getElementById("standBtn").disabled = false;
          document.getElementById("doubleBtn").disabled = false;
          showMessage("Tu turno: ped√≠ carta, plantate o dobl√°", "info");
        }
      }

      function hit() {
        if (!gameInProgress) return;

        dealCard(playerHand);
        renderHands();

        const playerTotal = calculateHand(playerHand);

        if (playerTotal > 21) {
          endGame("bust");
        } else if (playerTotal === 21) {
          stand();
        } else {
          canDouble = false;
          document.getElementById("doubleBtn").disabled = true;
        }
      }

      function stand() {
        if (!gameInProgress) return;

        document.getElementById("hitBtn").disabled = true;
        document.getElementById("standBtn").disabled = true;
        document.getElementById("doubleBtn").disabled = true;

        revealDealerCard();

        setTimeout(() => {
          dealerPlay();
        }, 500);
      }

      function revealDealerCard() {
        renderHands();
      }

      function dealerPlay() {
        let dealerTotal = calculateHand(dealerHand);

        while (dealerTotal < 17) {
          dealCard(dealerHand);
          dealerTotal = calculateHand(dealerHand);
          renderHands();
        }

        setTimeout(() => {
          determineWinner();
        }, 500);
      }

      function determineWinner() {
        const playerTotal = calculateHand(playerHand);
        const dealerTotal = calculateHand(dealerHand);

        if (dealerTotal > 21) {
          endGame("dealerBust");
        } else if (playerTotal > dealerTotal) {
          endGame("win");
        } else if (dealerTotal > playerTotal) {
          endGame("lose");
        } else {
          endGame("draw");
        }
      }

      function doubleDown() {
        if (!gameInProgress || !canDouble) return;
        if (chips < currentBet) {
          showMessage("No ten√©s suficientes fichas para doblar", "info");
          return;
        }

        chips -= currentBet;
        currentBet *= 2;
        dealCard(playerHand);
        renderHands();
        updateUI();

        const playerTotal = calculateHand(playerHand);

        if (playerTotal > 21) {
          endGame("bust");
        } else {
          stand();
        }
      }

      function endGame(result) {
        gameInProgress = false;
        canDouble = false;

        document.getElementById("hitBtn").disabled = true;
        document.getElementById("standBtn").disabled = true;
        document.getElementById("doubleBtn").disabled = true;
        document.getElementById("dealBtn").disabled = true;
        document.getElementById("newGameBtn").disabled = false;

        const playerTotal = calculateHand(playerHand);
        const dealerTotal = calculateHand(dealerHand);

        let message = "";
        let messageClass = "";

        switch (result) {
          case "blackjack":
            const winnings = Math.floor(currentBet * 2.5);
            chips += winnings;
            message = `¬°Blackjack! Ganaste ${winnings} fichas`;
            messageClass = "win";
            wins++;
            break;
          case "bust":
            message = `Te pasaste de 21. Perdiste ${currentBet} fichas`;
            messageClass = "lose";
            losses++;
            break;
          case "dealerBust":
            const winAmount = currentBet * 2;
            chips += winAmount;
            message = `El crupier se pas√≥. Ganaste ${winAmount} fichas`;
            messageClass = "win";
            wins++;
            break;
          case "win":
            const winChips = currentBet * 2;
            chips += winChips;
            message = `Ganaste con ${playerTotal} vs ${dealerTotal}. Ganaste ${winChips} fichas`;
            messageClass = "win";
            wins++;
            break;
          case "lose":
            message = `Perdiste con ${playerTotal} vs ${dealerTotal}. Perdiste ${currentBet} fichas`;
            messageClass = "lose";
            losses++;
            break;
          case "draw":
            chips += currentBet;
            message = `Empate con ${playerTotal}. Se devuelve tu apuesta`;
            messageClass = "draw";
            break;
        }

        showMessage(message, messageClass);
        updateUI();

        if (chips === 0) {
          setTimeout(() => {
            if (
              confirm(
                "Te quedaste sin fichas. ¬øQuer√©s empezar de nuevo con 1000 fichas?"
              )
            ) {
              chips = 1000;
              wins = 0;
              losses = 0;
              currentBet = 0;
              updateUI();
              newGame();
            }
          }, 1000);
        }
      }

      function newGame() {
        playerHand = [];
        dealerHand = [];
        currentBet = 0;
        gameInProgress = false;
        canDouble = false;

        document.getElementById("dealBtn").disabled = false;
        document.getElementById("hitBtn").disabled = true;
        document.getElementById("standBtn").disabled = true;
        document.getElementById("doubleBtn").disabled = true;
        document.getElementById("newGameBtn").disabled = true;

        document
          .querySelectorAll(".bet-btn")
          .forEach((btn) => btn.classList.remove("selected"));

        renderHands();
        showMessage('Apost√° y presion√° "Repartir" para comenzar', "info");
        updateUI();
      }

      function updateUI() {
        document.getElementById("chips").textContent = chips;
        document.getElementById("currentBet").textContent = currentBet;
        document.getElementById("wins").textContent = wins;
        document.getElementById("losses").textContent = losses;
      }

      function showMessage(text, type) {
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = text;
        messageDiv.className = "message " + type;
      }

      // ===== PROVABLY FAIR SYSTEM =====

      // Variables para Provably Fair
      let serverSeed = generateRandomString(32);
      let serverSeedHash = sha256(serverSeed);
      let clientSeed = generateRandomString(16);
      let nonce = 0;
      let gameHistory = [];
      let currentServerSeedRevealed = false;

      // Funci√≥n SHA-256 (implementaci√≥n simplificada para demostraci√≥n)
      async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
        return hashHex;
      }

      // Generar string aleatorio
      function generateRandomString(length) {
        const chars =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        let result = "";
        const randomValues = new Uint8Array(length);
        crypto.getRandomValues(randomValues);
        for (let i = 0; i < length; i++) {
          result += chars[randomValues[i] % chars.length];
        }
        return result;
      }

      // Generar resultado verificable
      function generateProvablyFairResult(serverSeed, clientSeed, nonce) {
        const combined = `${serverSeed}:${clientSeed}:${nonce}`;
        let hash = 0;
        for (let i = 0; i < combined.length; i++) {
          const char = combined.charCodeAt(i);
          hash = (hash << 5) - hash + char;
          hash = hash & hash;
        }
        return Math.abs(hash);
      }

      // Barajado Provably Fair usando las semillas
      function shuffleDeckProvablyFair() {
        const seed = generateProvablyFairResult(serverSeed, clientSeed, nonce);
        let currentIndex = deck.length;
        let randomValue = seed;

        while (currentIndex !== 0) {
          randomValue = (randomValue * 9301 + 49297) % 233280;
          const randomIndex = Math.floor((randomValue / 233280) * currentIndex);
          currentIndex--;
          [deck[currentIndex], deck[randomIndex]] = [
            deck[randomIndex],
            deck[currentIndex],
          ];
        }
      }

      // Toggle panel Provably Fair
      function toggleProvablyFair() {
        const content = document.getElementById("fairContent");
        const toggle = document.getElementById("fairToggle");
        content.classList.toggle("active");
        toggle.textContent = content.classList.contains("active") ? "‚ñ≤" : "‚ñº";
      }

      // Generar nueva client seed
      function generateClientSeed() {
        clientSeed = generateRandomString(16);
        document.getElementById("clientSeed").value = clientSeed;
        showMessage("Nueva Client Seed generada", "info");
      }

      // Copiar seed al portapapeles
      function copySeed(elementId) {
        const input = document.getElementById(elementId);
        input.select();
        document.execCommand("copy");
        showMessage("Copiado al portapapeles", "info");
      }

      // Revelar server seed
      function revealServerSeed() {
        if (currentServerSeedRevealed) {
          showMessage("El Server Seed ya fue revelado", "info");
          return;
        }

        const result = document.getElementById("verificationResult");
        result.innerHTML = `
          <h3 style="color: #00ff88; margin-bottom: 10px;">üîì Server Seed Revelado</h3>
          <p><strong>Server Seed:</strong> <code style="color: #ffaa00;">${serverSeed}</code></p>
          <p><strong>Hash SHA-256:</strong> <code>${serverSeedHash}</code></p>
          <p style="margin-top: 10px; color: #88ccff;">Ahora puedes verificar que este seed coincide con el hash mostrado anteriormente.</p>
          <p style="margin-top: 10px; color: #ff8888;">‚ö†Ô∏è Se generar√° un nuevo Server Seed para las pr√≥ximas rondas.</p>
        `;
        result.className = "verification-result success show";

        currentServerSeedRevealed = true;

        // Generar nuevo server seed
        setTimeout(() => {
          serverSeed = generateRandomString(32);
          sha256(serverSeed).then((hash) => {
            serverSeedHash = hash;
            document.getElementById("serverSeedHash").value = serverSeedHash;
            currentServerSeedRevealed = false;
            nonce = 0;
            updateProvablyFairUI();
          });
        }, 3000);
      }

      // Verificar equidad
      async function verifyFairness() {
        const result = document.getElementById("verificationResult");

        if (gameHistory.length === 0) {
          result.innerHTML = `
            <h3 style="color: #ffaa00;">‚ö†Ô∏è Sin Historial</h3>
            <p>Juega al menos una ronda para poder verificar la equidad.</p>
          `;
          result.className = "verification-result show";
          return;
        }

        const lastGame = gameHistory[gameHistory.length - 1];
        const calculatedHash = await sha256(lastGame.serverSeed);
        const hashMatch = calculatedHash === lastGame.serverSeedHash;

        result.innerHTML = `
          <h3 style="color: ${hashMatch ? "#00ff88" : "#ff8888"};">
            ${hashMatch ? "‚úì Verificaci√≥n Exitosa" : "‚úó Verificaci√≥n Fallida"}
          </h3>
          <div style="margin-top: 15px;">
            <p><strong>Ronda #${lastGame.nonce}</strong></p>
            <p><strong>Server Seed Hash:</strong> <code style="font-size: 0.8em;">${
              lastGame.serverSeedHash
            }</code></p>
            <p><strong>Client Seed:</strong> <code>${
              lastGame.clientSeed
            }</code></p>
            <p><strong>Resultado:</strong> ${lastGame.result}</p>
            <p style="margin-top: 10px; color: ${
              hashMatch ? "#88ffaa" : "#ff8888"
            };">
              ${
                hashMatch
                  ? "‚úì El hash coincide. La ronda fue justa y no manipulada."
                  : "‚úó El hash no coincide. Posible manipulaci√≥n detectada."
              }
            </p>
          </div>
        `;
        result.className = `verification-result ${
          hashMatch ? "success" : "error"
        } show`;
      }

      // Mostrar historial
      function showHistory() {
        const historyDiv = document.getElementById("gameHistory");

        if (gameHistory.length === 0) {
          historyDiv.innerHTML =
            '<p style="text-align: center; color: #999;">No hay historial de juegos a√∫n.</p>';
          return;
        }

        let html =
          '<h3 style="color: #0066cc; margin-bottom: 15px;">üìú Historial de Rondas</h3>';

        gameHistory
          .slice()
          .reverse()
          .forEach((game, index) => {
            html += `
            <div class="history-item">
              <div class="round-number">Ronda #${game.nonce}</div>
              <div class="result">
                <strong>Resultado:</strong> ${game.result}<br>
                <strong>Hash:</strong> ${game.serverSeedHash.substring(
                  0,
                  16
                )}...<br>
                <strong>Client Seed:</strong> ${game.clientSeed}
              </div>
            </div>
          `;
          });

        historyDiv.innerHTML = html;
      }

      // Actualizar UI de Provably Fair
      function updateProvablyFairUI() {
        document.getElementById("serverSeedHash").value = serverSeedHash;
        document.getElementById("clientSeed").value = clientSeed;
        document.getElementById("nonce").value = nonce;
      }

      // Guardar ronda en historial
      function saveGameToHistory(result) {
        gameHistory.push({
          nonce: nonce,
          serverSeed: serverSeed,
          serverSeedHash: serverSeedHash,
          clientSeed: clientSeed,
          result: result,
          timestamp: new Date().toISOString(),
        });

        nonce++;
        updateProvablyFairUI();
      }

      // Modificar la funci√≥n createDeck para usar Provably Fair
      const originalCreateDeck = createDeck;
      createDeck = function () {
        deck = [];
        for (let suit of suits) {
          for (let value of values) {
            deck.push({ suit, value });
          }
        }
        shuffleDeckProvablyFair(); // Usar barajado Provably Fair
      };

      // Modificar endGame para guardar en historial
      const originalEndGame = endGame;
      endGame = function (result) {
        originalEndGame(result);
        saveGameToHistory(result);
      };

      // Inicializar Provably Fair
      sha256(serverSeed).then((hash) => {
        serverSeedHash = hash;
        updateProvablyFairUI();
      });

      createDeck();
      updateUI();
      renderHands();
    </script>
  </body>
</html>
